# Azure DevOps Secureline Pipeline YAML
trigger:
  none

resources:
  pipelines:
    - pipeline: terraformPipeline
      source: terraform-deploy
      trigger:
        branches:
          include:
            - main

pool:
  name: Default
  demands: agent.name -equals securelinedemo

variables:
- group: secureline-secret
- name: GitHubRepoURL
  value: 'https://github.com/iamgagantyagi/WebGoat'
- name: GitHubRepoOwner
  value: 'iamgagantyagi'
- name: GitHubRepoName
  value: 'WebGoat'
- name: GitHubBranch
  value: 'main'
- name: ArtifactStorageAccount
  value: 'securelinestorage'
- name: ArtifactContainerName
  value: 'securelineartifacts'
- name: GVM_USER
  value: 'admin'
- name: GVM_PASSWORD
  value: 'Admin1234!'
- name: TARGET_NAME
  value: 'secureline-target'
- name: TASK_NAME
  value: 'secureline-vunerability-scan'
- name: SCAN_TIMEOUT
  value: '600'

stages:
  - stage: Initialize
    jobs:
      - job: SourceAction
        steps:
          - checkout: self
            clean: true
            path: s/MyAppSourceArtifact
          - script: echo "Source code has been checked out"
            displayName: 'Check out source code'

  - stage: HostVulnerabilityAssessment
    jobs:
      - job: BuildAction
        steps:
          - script: |
              echo "Checking if OpenVAS is already running..."
              cd /home/ubuntu/
              if docker-compose ps --services --filter "status=running" | grep -q .; then
                echo "OpenVAS containers are already running, skipping installation"
              else
                max_attempts=3
                attempt=1
                while [ $attempt -le $max_attempts ]; do
                  echo "Starting OpenVAS (attempt $attempt/$max_attempts)..."
                  
                  # Use nohup to ensure the docker-compose command continues even if the shell exits
                  nohup docker-compose up -d > openvas_startup.log 2>&1
                  
                  # Check if docker-compose started successfully
                  if [ $? -eq 0 ]; then
                    # Check if containers are actually running
                    sleep 10
                    running_containers=$(docker-compose ps --services --filter "status=running" | wc -l)
                    
                    if [ $running_containers -gt 0 ]; then
                      echo "OpenVAS started successfully with $running_containers containers running"
                      
                      # Add error handling for the password setup
                      echo "Setting OpenVAS admin password"
                      if docker compose exec --user=gvmd gvmd gvmd --user=admin --new-password=Admin1234!; then
                        echo "Password set successfully"
                        break
                      else
                        echo "Failed to set password, but containers are running. Will retry..."
                      fi
                    else
                      echo "Docker-compose started but no containers are running"
                    fi
                  fi
                  
                  echo "Failed to start OpenVAS properly, retrying in 30 seconds..."
                  docker-compose down
                  sleep 30
                  attempt=$((attempt+1))
                done
                if [ $attempt -gt $max_attempts ]; then
                  echo "Warning: Failed to start OpenVAS properly after $max_attempts attempts"
                  echo "Continuing with installation. OpenVAS may need manual configuration later."
                else
                  echo "OpenVAS setup completed successfully"
                fi
              fi
            displayName: 'Install OpenVAS'
          - script: |
              echo "Installing dependencies for Host Vulnerability Assessment"
              TARGET_IP=$(ip -4 addr show eth0 | grep -oP '(?<=inet\s)\d+(\.\d+){3}')
              DOCKER_CONTAINER_ID=$(sudo docker ps --filter "name=gvm-tools" --format "{{.ID}}")

              echo "Creating target and initiating scan..."
              # Check if target exists or create it
              TARGET_RESPONSE=$(sudo docker exec -u gvm $DOCKER_CONTAINER_ID gvm-cli --gmp-username "$(GVM_USER)" --gmp-password "$(GVM_PASSWORD)" socket --xml "<create_target><name>$(TARGET_NAME)</name><hosts>$TARGET_IP</hosts><port_range>1-65535</port_range></create_target>")
              
              if [[ "$TARGET_RESPONSE" == *"Target exists already"* ]]; then
                TARGET_ID=$(sudo docker exec -u gvm $DOCKER_CONTAINER_ID gvm-cli --gmp-username "$(GVM_USER)" --gmp-password "$(GVM_PASSWORD)" socket --xml "<get_targets/>" | xmlstarlet sel -t -m "//target[name='$(TARGET_NAME)']" -v "@id" -n)
              else
                TARGET_ID=$(echo '$TARGET_RESPONSE' | xmlstarlet sel -t -m "//create_target_response" -v "@id" -n)
              fi
              
              # Create and start task in one step
              TASK_RESPONSE=$(sudo docker exec -u gvm $DOCKER_CONTAINER_ID gvm-cli --gmp-username "$(GVM_USER)" --gmp-password "$(GVM_PASSWORD)" socket --xml "<create_task><name>$(TASK_NAME)</name><target id='$TARGET_ID'/><config id='08b69003-5fc2-4037-a479-93b440211c73'/><scanner id='daba56c8-73ec-11df-a475-002264764cea'/></create_task>")
              TASK_ID=$(echo '$TASK_RESPONSE' | xmlstarlet sel -t -m "//create_task_response" -v "@id" -n)
              
              # Start the scan
              sudo docker exec -u gvm $DOCKER_CONTAINER_ID gvm-cli --gmp-username "$(GVM_USER)" --gmp-password "$(GVM_PASSWORD)" socket --xml "<start_task task_id='$TASK_ID' />"
              
              # Monitor scan with simplified polling
              TIMEOUT=$(( $(date +%s) + $(SCAN_TIMEOUT) ))
              while [ $(date +%s) -lt $TIMEOUT ]; do
                SCAN_STATUS=$(sudo docker exec -u gvm $DOCKER_CONTAINER_ID gvm-cli --gmp-username "$(GVM_USER)" --gmp-password "$(GVM_PASSWORD)" socket --xml "<get_tasks task_id='$TASK_ID'/>")
                
                if [[ "$SCAN_STATUS" == *"<status>Done</status>"* ]]; then
                  REPORT_ID=$(echo "$SCAN_STATUS" | xmlstarlet sel -t -m "//report" -v "@id" -n)
                  echo "Scan completed. Report ID: $REPORT_ID"
                  break
                fi
                
                echo "Scan in progress... ($(( $TIMEOUT - $(date +%s) )) seconds remaining)"
                sleep 30
              done
              
              # Check if we timed out
              if [[ -z "$REPORT_ID" ]]; then
                echo "##vso[task.logissue type=error]Scan timed out"
                exit 1
              fi
              
              # Generate XML report instead of PDF
              echo "Generating XML vulnerability report..."
              sudo docker exec -u $DOCKER_CONTAINER_ID gvm-cli --gmp-username "$(GVM_USER)" --gmp-password "$(GVM_PASSWORD)" socket --xml "<get_reports report_id='$REPORT_ID' format_id='5057e5cc-b825-11e4-9d0e-28d24461215b' details='True' />" | \
              grep -oP '(?<=</report_format>)[^<]+' | \
              base64 -d > /home/ubuntu/CIS_Audit.xml
              
              # Check if report was generated
              if [ -f /home/ubuntu/CIS_Audit.xml ]; then
                echo "XML report generated successfully"
              else
                echo "Report generation failed"
                exit 1
              fi

            displayName: 'Run Host Vulnerability Assessment'

  - stage: SecretsScanner
    dependsOn: Initialize
    jobs:
      - job: BuildAction
        steps:
          - script: |
              echo "Checking if trufflehog3 is already installed..."
              if pip list 2>/dev/null | grep -q trufflehog3; then
                echo "trufflehog3 is already installed, skipping installation"
              else
                echo "Installing dependencies for Secret Scanning"
                pip install trufflehog3
              fi
            displayName: 'Install Secret Scanning dependencies' 
          - script: |
              echo "Started scanning code repositories for vulnerabilities related to secret keys."
              /home/ubuntu/.local/bin/trufflehog3 $(GitHubRepoURL) --no-history -f json -o truffelhog_output.json || true
              echo "Scanning completed."
            displayName: 'Run Trufflehog3 Scan'
          - task: AzureCLI@2
            inputs:
              azureSubscription: 'secureline'
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                az storage blob upload --file truffelhog_output.json --container-name $(ArtifactContainerName) --name securelinescanoutput/truffelhog_output.json --account-name $(ArtifactStorageAccount) --overwrite
            displayName: 'Upload Trufflehog3 Scan Results'

          - script: |
              echo "Sending SonarQube security findings to DefectDojo"
              curl -X POST "http://$(DefectDojoDomain):30001/api/v2/import-scan/" \
              -H "accept: application/json" \
              -H "Authorization: Token $(defectdojotoken)" \
              -H "Content-Type: multipart/form-data" \
              -F "active=true" \
              -F "verified=true" \
              -F "close_old_findings=false" \
              -F "test_title=Secureline" \
              -F "push_to_jira=false" \
              -F "minimum_severity=Info" \
              -F "close_old_findings_product_scope=false" \
              -F "scan_date=$(date +%F)" \
              -F "create_finding_groups_for_all_findings=true" \
              -F "tags=Secureline" \
              -F "scan_type=Trufflehog3 Scan" \
              -F "file=@truffelhog_output.json" \
              -F "engagement=1"
              if [ $? -eq 0 ]; then echo -e "\nReport sent successfully"; else echo -e "\nFailed to send report"; fi
            displayName: 'Send Trufflehog3 Results to DefectDojo' 

  - stage: SourceCompositionAnalysis
    jobs:
      - job: BuildAction
        steps:
          - script: |
              echo "Checking if Dependency Check is already installed..."
              if [ -d "/home/ubuntu/dependency-check" ] && [ -f "/home/ubuntu/dependency-check/bin/dependency-check.sh" ]; then
                echo "Dependency Check is already installed, skipping installation"
              else
                echo "Installing dependencies for Source Composition Analysis"
                cd /home/ubuntu/
                rm -rf dependency-check
                wget https://github.com/jeremylong/DependencyCheck/releases/download/v7.4.0/dependency-check-7.4.0-release.zip
                unzip -o dependency-check-7.4.0-release.zip
                rm -rf dependency-check-7.4.0-release.zip
                chmod -R 775 dependency-check/bin/dependency-check.sh
                echo 'export PATH=/home/ubuntu/dependency-check/bin:$PATH' >> ~/.bashrc
                source ~/.bashrc 
              fi
            displayName: 'Install Source Composition Analysis dependencies'
          - script: |
              export PATH=/home/ubuntu/dependency-check/bin:$PATH
              echo "Started scanning to detect publicly disclosed vulnerabilities contained within project's dependencies"          
              git clone https://github.com/iamgagantyagi/WebGoat.git $HOME/WebGoat
              dependency-check.sh -o '/home/ubuntu/' -s '/home/ubuntu/WebGoat' -f 'ALL' --prettyPrint
              echo "Scanning completed."
            displayName: 'Run Dependency Check'  
          - task: AzureCLI@2
            inputs:
              azureSubscription: 'secureline'
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                az storage blob upload --file /home/ubuntu/dependency-check-report.xml --container-name $(ArtifactContainerName) --name securelinescanoutput/dependency-check-report.xml --account-name $(ArtifactStorageAccount) --overwrite
            displayName: 'Upload Dependency Check Results'

          - script: |
              echo "Sending SonarQube security findings to DefectDojo"
              curl -X POST "http://$(DefectDojoDomain):30001/api/v2/import-scan/" \
              -H "accept: application/json" \
              -H "Authorization: Token $(defectdojotoken)" \
              -H "Content-Type: multipart/form-data" \
              -F "active=true" \
              -F "verified=true" \
              -F "close_old_findings=false" \
              -F "test_title=Secureline" \
              -F "push_to_jira=false" \
              -F "minimum_severity=Info" \
              -F "close_old_findings_product_scope=false" \
              -F "scan_date=$(date +%F)" \
              -F "create_finding_groups_for_all_findings=true" \
              -F "tags=Secureline" \
              -F "scan_type=Dependency Check Scan" \
              -F "file=@dependency-check-report.xml;type=text/xml" \
              -F "engagement=1"
              if [ $? -eq 0 ]; then echo -e "\nReport sent successfully"; else echo -e "\nFailed to send report"; fi
            displayName: 'Send SCA result to DefectDojo'             
        
 

  - stage: StaticApplicationSecurityTesting
    jobs:
      - job: BuildAction
        steps:
          - script: |
              echo "Checking if Sonar Scanner is already installed..."
              if [ -d "/opt/sonar-scanner" ] && [ -f "/opt/sonar-scanner/bin/sonar-scanner" ]; then
                echo "Sonar Scanner is already installed, skipping installation"
              else
                echo "Installing dependencies for Static Application Security Testing (SAST)"
                cd /home/ubuntu/
                # Check if maven is installed
                if ! command -v mvn &> /dev/null; then
                  sudo apt install -y maven
                else
                  echo "Maven is already installed, skipping installation"
                fi
                
                rm -rf sonar-scanner-5.0.1.3006-linux
                wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
                unzip sonar-scanner-cli-5.0.1.3006-linux.zip
                rm -rf sonar-scanner-cli-5.0.1.3006-linux.zip
                sudo mv sonar-scanner-5.0.1.3006-linux /opt/sonar-scanner
                chmod -R 775 /opt/sonar-scanner
              fi
            displayName: 'Install SAST dependencies'

          - script: |
              echo "Cloning the repository"
              git clone https://github.com/iamgagantyagi/WebGoat.git
              sudo apt install maven -y
            displayName: 'Clone Repository'

          - script: |
              echo "Started scanning for Static Application Security Testing (SAST)"
              cd $HOME/WebGoat
              git init
              mvn sonar:sonar -Dsonar.host.url="http://$(DefectDojoDomain):30000" -Dsonar.java.binaries="$HOME/WebGoat/src/main/java" -Dsonar.token="$(Sonartoken)" -Dsonar.projectKey="SecureLine"
              echo "Scanning completed."
              echo "Generating SonarQube report..."
              cd /home/ubuntu/
              curl -u "$(Sonartoken):" "http://$(DefectDojoDomain):30000/api/issues/search?componentKeys=securityproject" -o sonar-report.json
            displayName: 'Run SonarQube and store Scan'

          - script: |
              echo "Sending SonarQube security findings to DefectDojo"
              curl -X POST "http://$(DefectDojoDomain):30001/api/v2/import-scan/" \
              -H "accept: application/json" \
              -H "Authorization: Token $(defectdojotoken)" \
              -H "Content-Type: multipart/form-data" \
              -F "active=true" \
              -F "verified=true" \
              -F "close_old_findings=false" \
              -F "test_title=Secureline" \
              -F "push_to_jira=false" \
              -F "minimum_severity=Info" \
              -F "close_old_findings_product_scope=false" \
              -F "scan_date=$(date +%F)" \
              -F "create_finding_groups_for_all_findings=true" \
              -F "tags=Secureline" \
              -F "scan_type=SonarQube API Import" \
              -F "engagement=1"
              if [ $? -eq 0 ]; then echo -e "\nReport sent successfully"; else echo -e "\nFailed to send report"; fi
            displayName: 'Send SonarQube Results to DefectDojo'
            condition: 
          - script: |
               cd $HOME/WebGoat
               sudo mvn -N io.takari:maven:wrapper
               sudo chmod +x mvnw
               sudo mvn clean install -DskipTests
            displayName: CleanUp    


          - task: AzureCLI@2
            inputs:
              azureSubscription: 'secureline'
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                az storage blob upload --file /home/ubuntu/sonar-report.json --container-name $(ArtifactContainerName) --name securelinescanoutput/sonar-report.json --account-name $(ArtifactStorageAccount) --overwrite
            displayName: 'Upload SonarQube Scan Results'

  - stage: ContainersConfigurationScan
    jobs:
      - job: BuildAction
        steps:
          - script: |
              echo "Checking if Kubescape is already installed..."
              if command -v kubescape &> /dev/null; then
                echo "Kubescape is already installed, skipping installation"
              else
                echo "Installing dependencies for Containers Configuration Scan"
                cd /home/ubuntu/
                curl -s https://raw.githubusercontent.com/kubescape/kubescape/master/install.sh | /bin/bash
                echo 'export PATH=$PATH:$HOME/.kubescape/bin' >> ~/.bashrc
                source ~/.bashrc
              fi
            displayName: 'Install Container Scanning dependencies'
          - script: |
              echo "Scanning YAML for application"
              export PATH=$PATH:$HOME/.kubescape/bin
              kubescape scan /home/ubuntu/WebGoat/webgoat_K8S.yml --format junit --output /home/ubuntu/K8S_config_scan.xml
              echo "Scanning completed."
            displayName: 'Run Kubescape Scan'

          - task: AzureCLI@2
            inputs:
              azureSubscription: 'secureline'
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |  
                az storage blob upload --file /home/ubuntu/K8S_config_scan.xml --container-name $(ArtifactContainerName) --name securelinescanoutput/K8S_config_scan.xml --account-name $(ArtifactStorageAccount) --overwrite
            displayName: 'Upload Kubescape Scan Results'

  - stage: GenerateBuild
    jobs:
      - job: BuildAction
        steps:
          - script: |
              echo "Executing build commands"
              cd /home/ubuntu/WebGoat
              git checkout main
              sudo echo dckr_pat_n75Bge8xlnU_sJh8b3m6GgR_cg8 | sudo docker login --username gtyagi017 --password-stdin
              sudo ./mvnw clean install
              sudo docker build -f Dockerfile . -t webgoat/webgoat
              sudo docker tag webgoat/webgoat:latest gtyagi017/webgoat:latest
              sudo docker push gtyagi017/webgoat:latest
              echo "WebGoat Docker image pushed successfully on Docker Hub"
            displayName: 'Build and Push Docker Image'

  - stage: TrivyDockerImageScan
    dependsOn: GenerateBuild
    jobs:
      - job: BuildAction
        steps:
          - script: |
              echo "Checking if trivy is already installed..."
              if command -v trivy &> /dev/null; then
                echo "trivy is already installed, skipping installation"
              else
                cd /home/ubuntu/
                echo "Installing Trivy"
                curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b $HOME/.local/bin v0.17.2
                echo 'export PATH=$HOME/.local/bin:$PATH' >> ~/.bashrc
                source ~/.bashrc
              fi
              
            displayName: 'Install Trivy'
          - script: |
              export PATH=$HOME/.local/bin:$PATH
              echo "Scanning Docker image"
              cd /home/ubuntu/
              trivy image -f json -o /home/ubuntu/Trivy_result.json gtyagi017/webgoat:latest
              echo "Scanning completed."
            displayName: 'Run Trivy Scan'

          - task: AzureCLI@2
            inputs:
              azureSubscription: 'secureline'
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |  
                az storage blob upload --file /home/ubuntu/Trivy_result.json --container-name $(ArtifactContainerName) --name securelinescanoutput/Trivy_result.json --account-name $(ArtifactStorageAccount) --overwrite
            displayName: 'Upload Trivy Scan Results'

  - stage: DeployApplication
    jobs:
      - job: BuildAction
        steps:
          - script: |
              echo "Deploying Application on Kubernetes"
              kubectl apply -f /home/ubuntu/WebGoat/webgoat_K8S.yml
              echo "Deployment completed."
            displayName: 'Deploy Application'

  - stage: DynamicApplicationSecurityTesting
    jobs:
      - job: BuildAction
        steps:
          - script: |
              echo "Running ZAP docker container and scanning full Scan"
              mkdir /home/ubuntu/zapmount
              chmod -R 777 /home/ubuntu/zapmount
              sudo docker run --rm -v /home/ubuntu/zapmount:/zap/wrk/:rw -t softwaresecurityproject/zap-stable zap-full-scan.py -t http://$(DefectDojoDomain):30002/WebGoat -x /zap/wrk/zap_report.xml || true
              echo "Scanning completed."
            displayName: 'Run ZAP Scan'

          - task: AzureCLI@2
            inputs:
              azureSubscription: 'secureline'
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                az storage blob upload --file /home/ubuntu/zapmount/zap_report.xml --container-name $(ArtifactContainerName) --name securelinescanoutput/zap_report --account-name $(ArtifactStorageAccount) --overwrite
            displayName: 'Upload ZAP Scan Results'

          - script: |
              echo "Sending zap report to DefectDojo"
              curl -X POST "http://$(DefectDojoDomain):30001/api/v2/import-scan/" \
              -H "accept: application/json" \
              -H "Authorization: Token $(defectdojotoken)" \
              -H "Content-Type: multipart/form-data" \
              -F "active=true" \
              -F "verified=true" \
              -F "close_old_findings=false" \
              -F "test_title=Secureline" \
              -F "push_to_jira=false" \
              -F "minimum_severity=Info" \
              -F "close_old_findings_product_scope=false" \
              -F "scan_date=$(date +%F)" \
              -F "create_finding_groups_for_all_findings=true" \
              -F "product_name=Secureline" \
              -F "tags=zap_report" \
              -F "scan_type=ZAP Scan" \
              -F "file=@$(pwd)/zapmount/zap_report" \
              -F "engagement=1"
              if [ $? -eq 0 ]; then echo -e "\nReport sent successfully"; else echo -e "\nFailed to send report"; fi
            displayName: 'Send SonarQube Results to DefectDojo'

  - stage: ContainerScan
    jobs:
      - job: BuildAction
        steps:
          - script: |
              echo "Checking if Kubescape is already installed..."
              if command -v kubescape &> /dev/null; then
                echo "Kubescape is already installed, skipping installation"
              else
                echo "Installing dependencies for Containers Configuration Scan"
                cd /home/ubuntu/
                curl -s https://raw.githubusercontent.com/kubescape/kubescape/master/install.sh | /bin/bash
                echo 'export PATH=$PATH:$HOME/.kubescape/bin' >> ~/.bashrc
                source ~/.bashrc
              fi
            displayName: 'Install Container Scanning dependencies'
          - task: AzureCLI@2
            inputs:
              azureSubscription: 'secureline'
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                echo "kubescape scanning application namespace"
                export PATH=$PATH:$HOME/.kubescape/bin
                kubescape scan --include-namespaces webgoat-namespace --format junit --output /home/ubuntu/k8s_namespace_scan.xml
                echo "Uploading Kubescape scan results to Azure Blob Storage"
                az storage blob upload --file /home/ubuntu/k8s_namespace_scan.xml --container-name $(ArtifactContainerName) --name securelinescanoutput/k8s_namespace_scan.xml --account-name $(ArtifactStorageAccount) --overwrite
            displayName: 'Run Container Scan and upload results'   

  - stage: CloudScan
    jobs:
      - job: BuildAction
        steps:
          - script: |
              echo "Installing dependencies for Cloud Scan"
              sudo echo dckr_pat_n75Bge8xlnU_sJh8b3m6GgR_cg8 | sudo docker login --username gtyagi017 --password-stdin
            displayName: 'Install dependencies'

          - task: AzureCLI@2
            inputs:
              azureSubscription: 'secureline'
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                echo "Starting cloud scan"
                mkdir -p /home/ubuntu/report/
                docker run --memory="2.5g" -v /home/ubuntu/reports:/app/reports securityftw/cs-suite -env azure
                az storage blob upload-batch --source /home/ubuntu/reports/ --destination $(ArtifactContainerName)/CloudScan/ --account-name $(ArtifactStorageAccount) --overwrite
            displayName: 'Run Cloud Scan and upload results'       



          - task: AzureCLI@2
            inputs:
              azureSubscription: 'secureline'
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                az storage blob upload-batch --source /home/ubuntu/cis_report/ --destination $(ArtifactContainerName)/HostVA/ --account-name $(ArtifactStorageAccount) --overwrite
            displayName: 'Upload results to azure'


  - stage: FinalResult
    jobs:
      - job: BuildAction
        steps:
          - task: AzureCLI@2
            inputs:
              azureSubscription: 'secureline'
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                echo "Installing dependencies for Final Result"
                sudo apt-get install python3-dateutil python3-html2text -y
                cd /home/ubuntu/
                git clone https://github.com/iamgagantyagi/securelineparser.git
                az storage blob download-batch --source $(ArtifactContainerName)/ --destination /home/ubuntu/securelineparser/ --account-name $(ArtifactStorageAccount)
            displayName: 'Install dependencies and download artifacts'
          - task: AzureCLI@2
            inputs:
              azureSubscription: 'secureline'
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |  
                cd /home/ubuntu/securelineparser
                pip install -r requirements.txt
                pip install pyOpenSSL==22.0.0
                sudo export PYTHONPATH=/root/.pyenv/versions/3.9.17/lib/python3.9/site-packages
                python3 run_parser.py -t "ZAP Scan" -p "securelinescanoutput/zap_report" -o "consolidated_test_output.csv"
                python3 run_parser.py -t "CIS-Audit" -p "$(find securelinescanoutput/HostVA/ -name 'CIS_*.xml')" -o "consolidated_test_output.csv"
                python3 run_parser.py -t "DependencyCheck Scan" -p "securelinescanoutput/dependency-check-report.xml" -o "consolidated_test_output.csv"
                python3 run_parser.py -t "Kubescape Scanning" -p "securelinescanoutput/K8S_config_scan.xml" -o "consolidated_test_output.csv"
                python3 run_parser.py -t "Kubescape Scanning" -p "securelinescanoutput/k8s_namespace_scan.xml" -o "consolidated_test_output.csv"
                python3 run_parser.py -t "Trufflehog3 Scan" -p "securelinescanoutput/truffelhog_output.json" -o "consolidated_test_output.csv"
                python3 run_parser.py -t "Trivy Scanning" -p "securelinescanoutput/Trivy_result.json" -o "consolidated_test_output.csv"
                python3 run_parser.py -t "sonarqube" -u "http://$(DefectDojoDomain):30000" -k securityproject -b main -a "$Sonarqubeusertoken" -o "consolidated_test_output.csv"
                cd ../
                az storage blob upload --file /home/ubuntu/securelineparser/consolidated_test_output.csv --container-name $(ArtifactContainerName) --name securelinescanoutput/consolidated_test_output.csv --account-name $(ArtifactStorageAccount) --overwrite
                az storage blob move --source-container $(ArtifactContainerName) --source-name securelinescanoutput/ --dest-container $(ArtifactContainerName) --dest-name securelinescanoutput-$(date +"%Y%m%d-%H%M%S")/ --account-name $(ArtifactStorageAccount)
            displayName: 'Run Final Result Parser and upload results'